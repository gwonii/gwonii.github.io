# Improvement work on app crash

# Overview

이전 회사에서 앱에서 지속적인 앱 크래쉬 신고가 들어왔고, 앱 크래쉬를 사전에 방지할 수 없는가에 대한 요구사항이 들어왔었다.
그래서 근본적인 문제를 파악하여 최대한 앱 크래쉬를 제거하고자 하였다. 

# Cause Analysis

앱 크래쉬를 해결하기 위해 직접 원인을 찾기 전에는 앱 크래쉬가 발생되는 원인들이 너무 많아서 쉽게 해결하기 힘들 것이라고 생각하였다. 하지만 전체 앱 크래쉬 이슈를 리스트화 하였고 반복해서 보이는 원인들을 파악할 수 있었다.

1. optional 강제 추출로 인한 nil 참조
2. memory leak 으로 인한 메모리 과부하
3. UI 로직이 background thread 에서 동작되는 경우
4. out of index
5. 권한이 없는데 권한 관련 기능을 사용한 경우
...

# Solution

### 1. optional 강제 추출로 인한 nil 참조
- 강제추출 코드를 모두 제거하고 nil case에 대한 예외처리를 모두 작성하였다.
- nil의 경우 error와 달리 단순 데이터가 없음을 의미한다. 그렇기 때문에 nil 인 경우 해당 data의 상태가 어떻게 될지 정의하고 예외처리 코드를 추가하였다.

### 2. memory leak 으로 인한 메모리 과부하
- 순환참조 방지를 위하여 클래스 내에 프로퍼티 참조시 `self` 키워드를 제거하도록 제안하였다.

  : 그 이유는 순환참조의 대부분은 escaping closure 내부에서 외부 참조를 하는 경우에 발생한다고 판단하였고, escaping closure 내부에서 외부 참조를 하는 경우 self를 명시 하지않으면 컴파일 에러가 발생된다. 
  그 부분을 이용하여 컴파일 시점에 에러를 발생시켜 개발자의 실수를 방지하도록 하였다.

- 화면 별 메모리 사이즈에 대한 표를 만들고 pr 작성 전 메모리 디버깅 결과를 추가하도록 제도화하였다.

### 3. UI 로직이 background thread 에서 동작되는 경우
- UI의 상태를 외부에서 바꾸지 못하도록 UI 프로퍼티를 모두 private 접근제한자로 변경하였다.
- 모든 View를 handleOutput(_ output: Output) 메소드를 채택할 수 있도록 구성하였다.
- ViewModel(output) → ViewController(bind) → View - handleOutput() 로 역할을 확실히 분리하였고 ViewController에서 view의 handleOutput 을 호출할 때에 Thread를 MainThread 로 설정하도록 구성하였다.
- 일련의 과정들은 UI 갱신을 특정 메소드로 통일화 시켜서 Thread의 변경시점이 더 잘 보일 수 있도록 하였다. 

### 4. out of index
- 배열의 index 접근 코드를 모두 제거하였다.
- 값을 접근할 때는 최대한 `first`, `last` 등의 Array 인터페이스를 사용하였다.
- 불가피하게 index 접근을 해야 하는 경우에는 collection에 subscript를 추가하여 값이 없는 경우 nil을 반환할 수 있는 extension 을 추가하였다. 
    
### 5. 권한이 없는데 권한 관련 기능을 사용한 경우
- 위치 권한, 앨범 접근, 백그라우드 권한 등의 코드를 수정하는 경우에는 반드시 pr 코드리뷰 놓치지 않도록 `권한 관련 처리` 라벨을 명시하도록 제도화 하였다.
- `권한 관련 처리` 라벨이 포함되어 있는 경우에는 팀원 전체가 신중하게 코드리뷰를 할 수 있도록 유도하였다.
- `권한 관련 처리` 변경에 대해 쉽게 트래킹 할 수 있도록 `Tuist` 를 도입하였다.  

### 6. Crash 추적
- 마지막으로 Firebase crashlytics와 xcode organizer의 crash report 모니터링 담당자를 지정하였다.
- 주마다 담당자를 결정하여 앱 크래쉬를 모니터링하여 앱에서 크래쉬가 발생되는 경우 빠르게 대응할 수 있도록 하였다. 

# Conclusion
- 위의 일련의 과정들을 통해서 코드 컨벤션을 작성하였고 여러 행동들을 제도화하였다. 그 이후 앱 크래쉬율은 현저하게 떨어졌고 많을 때는 10% 까지 발생되었던 앱 크래쉬가 1% 미만으로 줄어드는 성과를 얻을 수 있었습니다.
- 이외에도 다양한 원인으로 인하여 발생되는 앱 크래쉬가 있었지만, 지속적으로 원인들을 리스트화 하고 관리하였다.